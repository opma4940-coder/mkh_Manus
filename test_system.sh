#!/bin/bash

# ═══════════════════════════════════════════════════════════════════════════════
# سكريبت اختبار تلقائي لنظام mkh_Manus
# يقوم بفحص جميع الخدمات والوظائف تلقائياً
# ═══════════════════════════════════════════════════════════════════════════════

set -e

echo "════════════════════════════════════════════════════════════════"
echo "🚀 بدء اختبار نظام mkh_Manus"
echo "════════════════════════════════════════════════════════════════"
echo ""

# الألوان
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# دالة للطباعة الملونة
print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}ℹ️  $1${NC}"
}

# ═══════════════════════════════════════════════════════════════════════════════
# 1. فحص الملفات المطلوبة
# ═══════════════════════════════════════════════════════════════════════════════
echo "1️⃣  فحص الملفات المطلوبة..."
echo "─────────────────────────────────────────────────────────────"

if [ -f ".env" ]; then
    print_success "ملف .env موجود"
else
    print_error "ملف .env غير موجود"
    echo "قم بإنشائه من .env.example"
    exit 1
fi

if [ -f "docker-compose.yml" ]; then
    print_success "ملف docker-compose.yml موجود"
else
    print_error "ملف docker-compose.yml غير موجود"
    exit 1
fi

if [ -f "Dockerfile" ]; then
    print_success "ملف Dockerfile موجود"
else
    print_error "ملف Dockerfile غير موجود"
    exit 1
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 2. فحص Docker
# ═══════════════════════════════════════════════════════════════════════════════
echo "2️⃣  فحص Docker..."
echo "─────────────────────────────────────────────────────────────"

if command -v docker &> /dev/null; then
    print_success "Docker مثبت"
    docker --version
else
    print_error "Docker غير مثبت"
    exit 1
fi

if command -v docker compose &> /dev/null || command -v docker-compose &> /dev/null; then
    print_success "Docker Compose مثبت"
else
    print_error "Docker Compose غير مثبت"
    exit 1
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 3. بناء النظام
# ═══════════════════════════════════════════════════════════════════════════════
echo "3️⃣  بناء النظام..."
echo "─────────────────────────────────────────────────────────────"

print_info "جاري بناء الصور... (قد يستغرق عدة دقائق)"

if docker compose build --no-cache 2>&1 | tee /tmp/build.log; then
    print_success "تم بناء النظام بنجاح"
else
    print_error "فشل بناء النظام"
    echo "راجع /tmp/build.log للتفاصيل"
    exit 1
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 4. تشغيل الخدمات
# ═══════════════════════════════════════════════════════════════════════════════
echo "4️⃣  تشغيل الخدمات..."
echo "─────────────────────────────────────────────────────────────"

print_info "جاري تشغيل جميع الخدمات..."

if docker compose up -d; then
    print_success "تم تشغيل الخدمات"
else
    print_error "فشل تشغيل الخدمات"
    exit 1
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 5. انتظار جاهزية الخدمات
# ═══════════════════════════════════════════════════════════════════════════════
echo "5️⃣  انتظار جاهزية الخدمات..."
echo "─────────────────────────────────────────────────────────────"

print_info "انتظار 30 ثانية لبدء الخدمات..."
sleep 30

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 6. فحص حالة الخدمات
# ═══════════════════════════════════════════════════════════════════════════════
echo "6️⃣  فحص حالة الخدمات..."
echo "─────────────────────────────────────────────────────────────"

services=("postgres" "redis" "minio" "api" "worker" "beat" "flower")

for service in "${services[@]}"; do
    if docker compose ps | grep -q "$service.*running"; then
        print_success "الخدمة $service تعمل"
    else
        print_error "الخدمة $service لا تعمل"
        docker compose logs --tail=20 "$service"
    fi
done

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 7. اختبار API
# ═══════════════════════════════════════════════════════════════════════════════
echo "7️⃣  اختبار API..."
echo "─────────────────────────────────────────────────────────────"

print_info "فحص صحة API..."

if curl -s -f http://localhost:8000/api/v1/health > /dev/null; then
    print_success "API يعمل بشكل صحيح"
    curl -s http://localhost:8000/api/v1/health | jq . || echo ""
else
    print_error "API لا يستجيب"
    docker compose logs --tail=50 api
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 8. اختبار PostgreSQL
# ═══════════════════════════════════════════════════════════════════════════════
echo "8️⃣  اختبار PostgreSQL..."
echo "─────────────────────────────────────────────────────────────"

if docker compose exec -T postgres pg_isready -U mkh_user -d mkh_manus > /dev/null 2>&1; then
    print_success "PostgreSQL جاهز"
else
    print_error "PostgreSQL غير جاهز"
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 9. اختبار Redis
# ═══════════════════════════════════════════════════════════════════════════════
echo "9️⃣  اختبار Redis..."
echo "─────────────────────────────────────────────────────────────"

if docker compose exec -T redis redis-cli -a mkh_redis_pass_2025 ping 2>/dev/null | grep -q "PONG"; then
    print_success "Redis يعمل بشكل صحيح"
else
    print_error "Redis لا يستجيب"
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 10. اختبار MinIO
# ═══════════════════════════════════════════════════════════════════════════════
echo "🔟 اختبار MinIO..."
echo "─────────────────────────────────────────────────────────────"

if curl -s -f http://localhost:9000/minio/health/live > /dev/null; then
    print_success "MinIO يعمل بشكل صحيح"
else
    print_error "MinIO لا يستجيب"
fi

echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# 11. عرض معلومات الوصول
# ═══════════════════════════════════════════════════════════════════════════════
echo "════════════════════════════════════════════════════════════════"
echo "✅ اكتمل الاختبار!"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "📊 معلومات الوصول:"
echo "─────────────────────────────────────────────────────────────"
echo "🌐 Dashboard:        http://localhost:8000"
echo "📖 API Docs:         http://localhost:8000/docs"
echo "🌺 Flower:           http://localhost:5555"
echo "   Username: admin"
echo "   Password: flower_admin_2025"
echo ""
echo "💾 MinIO Console:    http://localhost:9001"
echo "   Username: mkh_minio_admin"
echo "   Password: mkh_minio_secure_2025"
echo "─────────────────────────────────────────────────────────────"
echo ""
echo "📝 للاطلاع على السجلات:"
echo "   docker compose logs -f"
echo ""
echo "🛑 لإيقاف النظام:"
echo "   docker compose down"
echo ""
echo "════════════════════════════════════════════════════════════════"
