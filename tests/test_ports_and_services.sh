#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ° ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„
# ÙŠØ®ØªØ¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© ÙˆØªÙˆÙØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ”Œ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ° ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

FAILED=0
TOTAL_TESTS=0

# Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
log_test() {
    local test_name="$1"
    local result="$2"
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    
    if [ "$result" = "pass" ]; then
        echo "âœ… [$TOTAL_TESTS] $test_name"
    else
        echo "âŒ [$TOTAL_TESTS] $test_name"
        FAILED=$((FAILED + 1))
    fi
}

# Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù†ÙØ°
test_port() {
    local port="$1"
    local service_name="$2"
    
    if nc -z localhost "$port" 2>/dev/null; then
        log_test "Ø§Ù„Ù…Ù†ÙØ° $port ($service_name) Ù…ÙØªÙˆØ­" "pass"
        return 0
    else
        log_test "Ø§Ù„Ù…Ù†ÙØ° $port ($service_name) Ù…ÙØªÙˆØ­" "fail"
        return 1
    fi
}

# Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± HTTP endpoint
test_http() {
    local url="$1"
    local service_name="$2"
    local expected_code="${3:-200}"
    
    local response_code=$(curl -s -o /dev/null -w "%{http_code}" "$url" 2>/dev/null || echo "000")
    
    if [ "$response_code" = "$expected_code" ]; then
        log_test "HTTP $url ($service_name) ÙŠØ³ØªØ¬ÙŠØ¨ Ø¨Ù€ $expected_code" "pass"
        return 0
    else
        log_test "HTTP $url ($service_name) ÙŠØ³ØªØ¬ÙŠØ¨ Ø¨Ù€ $expected_code (Ø­ØµÙ„Ù†Ø§ Ø¹Ù„Ù‰ $response_code)" "fail"
        return 1
    fi
}

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© â•â•â•
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ”Œ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
test_port 8000 "FastAPI Backend"
test_port 5432 "PostgreSQL"
test_port 6379 "Redis"
test_port 9000 "MinIO API"
test_port 9001 "MinIO Console"
test_port 5555 "Flower (Celery Monitor)"

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø§Øª HTTP â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸŒ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø§Øª HTTP"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ø®ØªØ¨Ø§Ø± FastAPI
test_http "http://localhost:8000/" "FastAPI Root"
test_http "http://localhost:8000/docs" "FastAPI Swagger UI"
test_http "http://localhost:8000/openapi.json" "FastAPI OpenAPI Schema"
test_http "http://localhost:8000/health" "FastAPI Health Check"

# Ø§Ø®ØªØ¨Ø§Ø± MinIO
test_http "http://localhost:9000/minio/health/live" "MinIO Health Live"
test_http "http://localhost:9001/" "MinIO Console" "200"

# Ø§Ø®ØªØ¨Ø§Ø± Flower
test_http "http://localhost:5555/" "Flower Dashboard"

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ—„ï¸  Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ø®ØªØ¨Ø§Ø± PostgreSQL
if docker-compose exec -T postgres pg_isready -U mkh_user > /dev/null 2>&1; then
    log_test "PostgreSQL Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„" "pass"
else
    log_test "PostgreSQL Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„" "fail"
fi

# Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¬ÙˆØ¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if docker-compose exec -T postgres psql -U mkh_user -d mkh_manus -c "SELECT 1" > /dev/null 2>&1; then
    log_test "Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª mkh_manus Ù…ÙˆØ¬ÙˆØ¯Ø©" "pass"
else
    log_test "Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª mkh_manus Ù…ÙˆØ¬ÙˆØ¯Ø©" "fail"
fi

# Ø§Ø®ØªØ¨Ø§Ø± Redis
if docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
    log_test "Redis ÙŠØ³ØªØ¬ÙŠØ¨ Ù„Ø£Ù…Ø± PING" "pass"
else
    log_test "Redis ÙŠØ³ØªØ¬ÙŠØ¨ Ù„Ø£Ù…Ø± PING" "fail"
fi

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ø®ØªØ¨Ø§Ø± MinIO â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ø®ØªØ¨Ø§Ø± MinIO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¬ÙˆØ¯ Bucket
if docker-compose exec -T minio mc ls /data/ | grep -q "mkh-attachments"; then
    log_test "MinIO Bucket (mkh-attachments) Ù…ÙˆØ¬ÙˆØ¯" "pass"
else
    log_test "MinIO Bucket (mkh-attachments) Ù…ÙˆØ¬ÙˆØ¯" "fail"
fi

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ø®ØªØ¨Ø§Ø± Celery â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš™ï¸  Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ø®ØªØ¨Ø§Ø± Celery Worker"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ø®ØªØ¨Ø§Ø± ØªØ´ØºÙŠÙ„ Celery Worker
if docker-compose ps | grep -q "worker.*Up"; then
    log_test "Celery Worker ÙŠØ¹Ù…Ù„" "pass"
else
    log_test "Celery Worker ÙŠØ¹Ù…Ù„" "fail"
fi

# Ø§Ø®ØªØ¨Ø§Ø± Flower
if curl -s http://localhost:5555/api/workers | grep -q "celery"; then
    log_test "Flower ÙŠØ¹Ø±Ø¶ Workers" "pass"
else
    log_test "Flower ÙŠØ¹Ø±Ø¶ Workers" "fail"
fi

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
if ! docker-compose logs api | grep -i "CRITICAL\|FATAL" > /dev/null 2>&1; then
    log_test "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø³Ø¬Ù„Ø§Øª API" "pass"
else
    log_test "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø³Ø¬Ù„Ø§Øª API" "fail"
fi

if ! docker-compose logs worker | grep -i "CRITICAL\|FATAL" > /dev/null 2>&1; then
    log_test "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø³Ø¬Ù„Ø§Øª Worker" "pass"
else
    log_test "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø© ÙÙŠ Ø³Ø¬Ù„Ø§Øª Worker" "fail"
fi

# â•â•â• Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ â•â•â•
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ø§Ø®ØªØ¨Ø§Ø± Ø²Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
response_time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:8000/health 2>/dev/null || echo "999")
if (( $(echo "$response_time < 1.0" | bc -l) )); then
    log_test "Ø²Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© API Ø£Ù‚Ù„ Ù…Ù† 1 Ø«Ø§Ù†ÙŠØ© ($response_time s)" "pass"
else
    log_test "Ø²Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© API Ø£Ù‚Ù„ Ù…Ù† 1 Ø«Ø§Ù†ÙŠØ© ($response_time s)" "fail"
fi

# â•â•â• Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© â•â•â•
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ $FAILED -eq 0 ]; then
    echo "âœ… Ù†Ø¬Ø­Øª Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ° ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª! ($TOTAL_TESTS/$TOTAL_TESTS)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 0
else
    echo "âŒ ÙØ´Ù„ $FAILED Ù…Ù† $TOTAL_TESTS Ø§Ø®ØªØ¨Ø§Ø±"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
fi
