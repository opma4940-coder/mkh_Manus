#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุณูุฑูุจุช ูุดุฑ ูุธุงู mkh_Manus
# ูููู ุจุจูุงุก ูุชุดุบูู ุฌููุน ุงูุฎุฏูุงุช ูุชุทุจูู ุงูู migrations
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ุจุฏุก ุนูููุฉ ูุดุฑ ูุธุงู mkh_Manus"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุงูุชุญูู ูู ูุฌูุฏ Docker
if ! command -v docker &> /dev/null; then
    echo "โ Docker ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Docker ุฃููุงู."
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "โ Docker Compose ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Docker Compose ุฃููุงู."
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ ููู .env
if [ ! -f .env ]; then
    echo "โ๏ธ  ููู .env ุบูุฑ ููุฌูุฏุ ุณูุชู ูุณุฎู ูู .env.example"
    cp .env.example .env
    echo "โ ุชู ุฅูุดุงุก ููู .env - ูุฑุฌู ุชุญุฏูุซ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ุญุณุจ ุงูุญุงุฌุฉ"
fi

# ุฅููุงู ุงูุฎุฏูุงุช ุงููุฏููุฉ ุฅู ูุฌุฏุช
echo ""
echo "๐ ุฅููุงู ุงูุฎุฏูุงุช ุงููุฏููุฉ..."
docker-compose down -v 2>/dev/null || true

# ุจูุงุก ุงูุตูุฑ
echo ""
echo "๐จ ุจูุงุก ุตูุฑ Docker..."
docker-compose build --no-cache

# ุชุดุบูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃููุงู
echo ""
echo "๐๏ธ  ุชุดุบูู ูุงุนุฏุฉ ุงูุจูุงูุงุช PostgreSQL..."
docker-compose up -d postgres

# ุงูุงูุชุธุงุฑ ุญุชู ุชุตุจุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฌุงูุฒุฉ
echo ""
echo "โณ ุงูุชุธุงุฑ ุฌุงูุฒูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
for i in {1..30}; do
    if docker-compose exec -T postgres pg_isready -U ${POSTGRES_USER:-mkh_user} &> /dev/null; then
        echo "โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฌุงูุฒุฉ"
        break
    fi
    echo "   ูุญุงููุฉ $i/30..."
    sleep 2
done

# ุชุทุจูู ุงูู migrations
echo ""
echo "๐ ุชุทุจูู migrations ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
docker-compose exec -T postgres psql -U ${POSTGRES_USER:-mkh_user} -d ${POSTGRES_DB:-mkh_manus} < migrations/0001_init.sql 2>/dev/null || true

# ุชุดุบูู Redis ู MinIO
echo ""
echo "๐ด ุชุดุบูู Redis ู MinIO..."
docker-compose up -d redis minio

# ุงูุงูุชุธุงุฑ ุญุชู ุชุตุจุญ ุงูุฎุฏูุงุช ุฌุงูุฒุฉ
echo ""
echo "โณ ุงูุชุธุงุฑ ุฌุงูุฒูุฉ Redis ู MinIO..."
sleep 10

# ุฅูุดุงุก bucket ูู MinIO
echo ""
echo "๐ฆ ุฅูุดุงุก Bucket ูู MinIO..."
docker-compose exec -T minio mc alias set myminio http://localhost:9000 ${MINIO_ROOT_USER:-mkh_minio_admin} ${MINIO_ROOT_PASSWORD:-mkh_minio_secure_2025} 2>/dev/null || true
docker-compose exec -T minio mc mb myminio/${MINIO_BUCKET:-mkh-attachments} 2>/dev/null || echo "   Bucket ููุฌูุฏ ุจุงููุนู"

# ุชุดุบูู ุจุงูู ุงูุฎุฏูุงุช
echo ""
echo "๐ ุชุดุบูู ุฌููุน ุงูุฎุฏูุงุช..."
docker-compose up -d

# ุงูุงูุชุธุงุฑ ุญุชู ุชุตุจุญ ุฌููุน ุงูุฎุฏูุงุช ุฌุงูุฒุฉ
echo ""
echo "โณ ุงูุชุธุงุฑ ุฌุงูุฒูุฉ ุฌููุน ุงูุฎุฏูุงุช..."
sleep 15

# ุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช
echo ""
echo "๐ ุญุงูุฉ ุงูุฎุฏูุงุช:"
docker-compose ps

# ูุญุต ุตุญุฉ ุงูุฎุฏูุงุช
echo ""
echo "๐ ูุญุต ุตุญุฉ ุงูุฎุฏูุงุช..."

# ูุญุต API
if curl -f http://localhost:${API_PORT:-8000}/api/v1/health &> /dev/null; then
    echo "โ API ูุนูู ุจุดูู ุตุญูุญ"
else
    echo "โ๏ธ  API ูุง ูุณุชุฌูุจ (ูุฏ ูุญุชุงุฌ ููุช ุฅุถุงูู ููุจุฏุก)"
fi

# ูุญุต MinIO
if curl -f http://localhost:${MINIO_PORT:-9000}/minio/health/live &> /dev/null; then
    echo "โ MinIO ูุนูู ุจุดูู ุตุญูุญ"
else
    echo "โ๏ธ  MinIO ูุง ูุณุชุฌูุจ"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ุชู ูุดุฑ ุงููุธุงู ุจูุฌุงุญ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ุงูุฎุฏูุงุช ุงููุชุงุญุฉ:"
echo "   - ููุญุฉ ุงูุชุญูู: http://localhost:${API_PORT:-8000}"
echo "   - ุชูุซูู API: http://localhost:${API_PORT:-8000}/docs"
echo "   - MinIO Console: http://localhost:${MINIO_CONSOLE_PORT:-9001}"
echo "   - Flower (Celery): http://localhost:${FLOWER_PORT:-5555}"
echo ""
echo "๐ ูุนุฑุถ ุงูุณุฌูุงุช: docker-compose logs -f"
echo "๐ ูุฅููุงู ุงููุธุงู: docker-compose down"
echo "๐ ูุฅุนุงุฏุฉ ุงูุชุดุบูู: docker-compose restart"
echo ""
